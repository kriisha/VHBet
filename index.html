<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vrienden Bets Live</title>
  <style>
    :root{--bg:#0b0d12;--text:#e9eefc;--muted:#a9b3cc;--line:#23304a;--card:#121826;--btn:#3b82f6;--btn2:#1f2937;--danger:#ef4444;--ok:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(900px 500px at 20% 0%, #152043 0%, var(--bg) 60%);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 48px}
    h1{margin:0 0 6px;font-size:28px}
    .sub{margin:0;color:var(--muted)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:16px}
    h2{margin:0 0 12px;font-size:18px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media (min-width: 980px){.grid{grid-template-columns:1fr 1fr}}
    input, select{background:rgba(255,255,255,0.03);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;outline:none;min-width:220px}
    input::placeholder{color:rgba(233,238,252,0.45)}
    button{border:0;background:var(--btn);color:#081024;font-weight:800;padding:10px 12px;border-radius:10px;cursor:pointer}
    button.secondary{background:var(--btn2);color:var(--text);border:1px solid var(--line);font-weight:700}
    button.danger{background:var(--danger);color:#1b0a0a}
    .hint{margin:10px 0 0;color:var(--muted);font-size:13px}
    .tiny{font-size:12px;color:var(--muted)}
    .list{list-style:none;padding:0;margin:12px 0 0;display:flex;flex-direction:column;gap:8px}
    .item{display:flex;justify-content:space-between;align-items:center;gap:10px;border:1px solid var(--line);background:rgba(0,0,0,0.12);border-radius:12px;padding:10px 12px}
    .badge{font-size:12px;color:var(--muted)}
    .summary{margin-top:12px;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,0.18)}
    .table{width:100%;border-collapse:collapse;margin-top:12px;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
    .table th{color:var(--muted);font-weight:800}
    .table tr:last-child td{border-bottom:0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,0.18)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .marketCard{margin-top:12px}
    .optGrid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .optBtn{
      min-width: 190px;
      text-align:left;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.14);
      color: var(--text);
      cursor: pointer;
    }
    .optBtn:hover{filter:brightness(1.06)}
    .optTop{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .optLabel{font-weight:900}
    .optOdds{font-weight:900}
    .optMeta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px}
    .ok{color:var(--ok);font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Vrienden Bets Live</h1>
      <p class="sub">Iedereen ziet dezelfde sessie, live odds op basis van inzetten.</p>
    </header>

    <section class="card">
      <h2>Sessie</h2>
      <div class="row">
        <button id="btnCreate" type="button">Nieuwe sessie maken</button>
        <input id="joinCode" class="mono" placeholder="Join code" />
        <button id="btnJoin" class="secondary" type="button">Join</button>
        <button id="btnLeave" class="danger" type="button">Leave</button>
        <span id="status" class="tiny"></span>
      </div>

      <div style="margin-top:12px" class="row">
        <span class="pill">User <span id="userId" class="mono"></span></span>
        <span class="pill">Sessie <span id="sessionCode" class="mono"></span></span>
      </div>

      <p class="hint">
        Deel de sessiecode of deel de link, de code staat automatisch in de URL na create of join.
      </p>
    </section>

    <section class="card">
      <h2>Jouw speler</h2>
      <div class="row">
        <select id="playerSelect">
          <option value="">Selecteer speler</option>
        </select>
        <span class="tiny" id="playerHint"></span>
      </div>
      <p class="hint">
        Selecteer je speler, klik daarna op een optie en geef je inzet in.
      </p>
    </section>

    <section class="grid">
      <div class="card">
        <h2>Spelers</h2>
        <form id="playerForm" class="row">
          <input id="playerName" placeholder="Naam speler" autocomplete="off" />
          <button type="submit">Toevoegen</button>
        </form>
        <ul id="playerList" class="list"></ul>
        <p class="hint">Verwijderen kan enkel door de maker van die speler.</p>
      </div>

      <div class="card">
        <h2>Markten bouwen</h2>

        <form id="marketForm" class="row">
          <input id="marketTitle" placeholder="Titel, bv Eindresultaat" />
          <input id="marketMatch" placeholder="Match, bv Westerlo vs STVV" />
          <button type="submit">Markt maken</button>
        </form>

        <form id="optionForm" class="row" style="margin-top:10px">
          <select id="marketPick" style="min-width:260px">
            <option value="">Kies markt om opties toe te voegen</option>
          </select>
          <input id="optLabel" placeholder="Keuze label, bv 1 of Team 1 wint" style="min-width:260px" />
          <button type="submit" class="secondary">Optie toevoegen</button>
        </form>

        <p class="hint">
          Odds worden niet meer manueel gezet, ze komen live uit de inzet verdeling.
        </p>
      </div>
    </section>

    <section class="card">
      <h2>Markten</h2>
      <div id="marketsWrap"></div>
    </section>

    <section class="card">
      <h2>Overzicht inzetten</h2>
      <div id="selectionSummary" class="summary"></div>
      <div id="selectionTableWrap"></div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://cyctrlgnkurleyzqglgd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5Y3RybGdua3VybGV5enFnbGdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDQyMDAsImV4cCI6MjA4NTk4MDIwMH0._U1IRle7-QRBW-sTjNAbP27gLfTVr_xz0FoyXu80NZ0";

    const STORAGE = {
      sessionCode: "vb_live_session_code",
      playerId: "vb_live_player_id",
      lastStake: "vb_live_last_stake"
    };

    const els = {
      btnCreate: document.getElementById("btnCreate"),
      joinCode: document.getElementById("joinCode"),
      btnJoin: document.getElementById("btnJoin"),
      btnLeave: document.getElementById("btnLeave"),
      status: document.getElementById("status"),
      userId: document.getElementById("userId"),
      sessionCode: document.getElementById("sessionCode"),

      playerForm: document.getElementById("playerForm"),
      playerName: document.getElementById("playerName"),
      playerList: document.getElementById("playerList"),
      playerSelect: document.getElementById("playerSelect"),
      playerHint: document.getElementById("playerHint"),

      marketForm: document.getElementById("marketForm"),
      marketTitle: document.getElementById("marketTitle"),
      marketMatch: document.getElementById("marketMatch"),

      optionForm: document.getElementById("optionForm"),
      marketPick: document.getElementById("marketPick"),
      optLabel: document.getElementById("optLabel"),

      marketsWrap: document.getElementById("marketsWrap"),

      selectionSummary: document.getElementById("selectionSummary"),
      selectionTableWrap: document.getElementById("selectionTableWrap"),
    };

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let session = null; // { id, code }
    let realtimeChannel = null;

    let players = [];
    let markets = [];
    let optionsByMarket = new Map();
    let selections = [];

    function setStatus(msg) {
      els.status.textContent = msg || "";
      if (msg) setTimeout(() => (els.status.textContent = ""), 1800);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function money(n) {
      if (!Number.isFinite(n)) return "€0,00";
      return new Intl.NumberFormat("nl-BE", { style: "currency", currency: "EUR" }).format(n);
    }

    function fmtOdds(n) {
      if (!Number.isFinite(n)) return "∞";
      const capped = Math.min(n, 99.99);
      return capped.toFixed(2);
    }

    function setUrlCode(code) {
      const url = new URL(location.href);
      url.searchParams.set("code", code);
      history.replaceState(null, "", url.toString());
    }

    async function ensureAnonAuth() {
      const { data: s } = await supabase.auth.getSession();
      if (s?.session) return s.session;
      const { data, error } = await supabase.auth.signInAnonymously();
      if (error) throw error;
      return data.session;
    }

    async function createSession() {
      const { data, error } = await supabase.rpc("create_session");
      if (error) throw error;
      return data?.[0] || null;
    }

    async function joinSession(code) {
      const c = String(code || "").trim().toUpperCase();
      if (!c) throw new Error("No code");
      const { data, error } = await supabase.rpc("join_session", { p_code: c });
      if (error) throw error;
      return data?.[0] || null;
    }

    function teardownRealtime() {
      if (realtimeChannel) {
        supabase.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
    }

    function setupRealtime() {
      teardownRealtime();
      if (!session) return;

      realtimeChannel = supabase
        .channel("vb_live_" + session.id)
        .on("postgres_changes", { event: "*", schema: "public", table: "players", filter: "session_id=eq." + session.id }, async () => { await refreshAll(); })
        .on("postgres_changes", { event: "*", schema: "public", table: "markets", filter: "session_id=eq." + session.id }, async () => { await refreshAll(); })
        .on("postgres_changes", { event: "*", schema: "public", table: "market_options" }, async () => { await refreshAll(); })
        .on("postgres_changes", { event: "*", schema: "public", table: "selections", filter: "session_id=eq." + session.id }, async () => { await refreshAll(); })
        .subscribe();
    }

    async function refreshAll() {
      if (!session) return;

      const p = await supabase.from("players")
        .select("*")
        .eq("session_id", session.id)
        .order("created_at", { ascending: true });
      if (p.error) throw p.error;
      players = p.data || [];

      const m = await supabase.from("markets")
        .select("*")
        .eq("session_id", session.id)
        .order("created_at", { ascending: true });
      if (m.error) throw m.error;
      markets = m.data || [];

      optionsByMarket = new Map();
      if (markets.length) {
        const marketIds = markets.map(x => x.id);
        const o = await supabase.from("market_options")
          .select("*")
          .in("market_id", marketIds)
          .order("sort", { ascending: true });
        if (o.error) throw o.error;

        for (const opt of (o.data || [])) {
          const arr = optionsByMarket.get(opt.market_id) || [];
          arr.push(opt);
          optionsByMarket.set(opt.market_id, arr);
        }
      }

      const s = await supabase.from("selections")
        .select("*, players(name), market_options(label), markets(title, match_label)")
        .eq("session_id", session.id)
        .order("created_at", { ascending: true });
      if (s.error) throw s.error;
      selections = s.data || [];

      renderAll();
    }

    function renderPlayerSelect() {
      const current = els.playerSelect.value || localStorage.getItem(STORAGE.playerId) || "";
      els.playerSelect.innerHTML = "<option value=''>Selecteer speler</option>";

      for (const pl of players) {
        const opt = document.createElement("option");
        opt.value = pl.id;
        opt.textContent = pl.name;
        els.playerSelect.appendChild(opt);
      }

      if (current) els.playerSelect.value = current;
      if (els.playerSelect.value) localStorage.setItem(STORAGE.playerId, els.playerSelect.value);

      els.playerHint.textContent = els.playerSelect.value ? "Klik op een keuze om in te zetten" : "Selecteer eerst je speler";
    }

    function renderPlayersList() {
      els.playerList.innerHTML = "";

      if (!session) {
        els.playerList.innerHTML = "<li class='hint'>Join eerst een sessie.</li>";
        return;
      }

      if (!players.length) {
        els.playerList.innerHTML = "<li class='hint'>Nog geen spelers.</li>";
        return;
      }

      for (const pl of players) {
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = "<div><strong>" + escapeHtml(pl.name) + "</strong> <span class='badge'>speler</span></div>";

        const btn = document.createElement("button");
        btn.className = "secondary";
        btn.type = "button";
        btn.textContent = "Verwijder";
        btn.addEventListener("click", async () => {
          const res = await supabase.from("players").delete().eq("id", pl.id);
          if (res.error) setStatus("Geen rechten om te verwijderen");
        });

        li.appendChild(btn);
        els.playerList.appendChild(li);
      }
    }

    function renderMarketPick() {
      els.marketPick.innerHTML = "<option value=''>Kies markt om opties toe te voegen</option>";
      for (const m of markets) {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.title + (m.match_label ? "  " + m.match_label : "");
        els.marketPick.appendChild(opt);
      }
    }

    function getMarketStakeStats(marketId) {
      const opts = optionsByMarket.get(marketId) || [];
      const optionIds = new Set(opts.map(o => o.id));

      const optionStake = new Map();
      let total = 0;

      for (const s of selections) {
        if (s.market_id !== marketId) continue;
        if (!optionIds.has(s.option_id)) continue;
        const st = Number(s.stake || 0);
        if (!Number.isFinite(st) || st <= 0) continue;
        total += st;
        optionStake.set(s.option_id, (optionStake.get(s.option_id) || 0) + st);
      }

      const n = opts.length || 1;

      return { opts, totalStake: total, optionStake, nOptions: n };
    }

    function impliedOdds(totalStake, stakeOnOption, nOptions) {
      if (nOptions <= 0) nOptions = 1;

      if (!Number.isFinite(totalStake) || totalStake <= 0) {
        return { prob: 1 / nOptions, odds: nOptions };
      }

      const st = Number(stakeOnOption || 0);
      if (!Number.isFinite(st) || st <= 0) {
        return { prob: 0, odds: Infinity };
      }

      const prob = st / totalStake;
      const odds = 1 / prob;
      return { prob, odds };
    }

    function askStake(defaultValue) {
      const raw = prompt("Hoeveel wil je inzetten in euro", defaultValue);
      if (raw === null) return null;
      const v = parseFloat(String(raw).replace(",", "."));
      if (!Number.isFinite(v) || v <= 0) return null;
      return v;
    }

    async function placeOrUpdateSelection(marketId, optionId) {
      const playerId = els.playerSelect.value;
      if (!playerId) {
        setStatus("Selecteer eerst je speler");
        return;
      }

      const prev = localStorage.getItem(STORAGE.lastStake) || "5";
      const stake = askStake(prev);
      if (stake === null) {
        setStatus("Ongeldige inzet");
        return;
      }
      localStorage.setItem(STORAGE.lastStake, String(stake));

      const user = (await supabase.auth.getUser()).data.user;

      const payload = {
        session_id: session.id,
        market_id: marketId,
        option_id: optionId,
        player_id: playerId,
        created_by: user.id,
        stake: stake
      };

      const up = await supabase
        .from("selections")
        .upsert(payload, { onConflict: "market_id,player_id" });

      if (up.error) setStatus("Kon inzet niet opslaan");
    }

    function renderMarkets() {
      els.marketsWrap.innerHTML = "";

      if (!session) {
        els.marketsWrap.innerHTML = "<p class='hint'>Join eerst een sessie.</p>";
        return;
      }

      if (!markets.length) {
        els.marketsWrap.innerHTML = "<p class='hint'>Maak een markt en voeg opties toe, odds komen vanzelf.</p>";
        return;
      }

      for (const m of markets) {
        const stats = getMarketStakeStats(m.id);
        const { opts, totalStake, optionStake, nOptions } = stats;

        const card = document.createElement("div");
        card.className = "card marketCard";

        const head = document.createElement("div");
        head.className = "row";
        head.style.justifyContent = "space-between";

        const left = document.createElement("div");
        const potTxt = totalStake > 0 ? money(totalStake) : "€0,00";
        left.innerHTML =
          "<div><strong>" + escapeHtml(m.title) + "</strong> <span class='badge'>" + escapeHtml(m.match_label || "") + "</span></div>" +
          "<div class='tiny'>Pot in deze markt: <span class='ok'>" + potTxt + "</span> | Opties: " + nOptions + "</div>";

        const del = document.createElement("button");
        del.className = "secondary";
        del.type = "button";
        del.textContent = "Verwijder markt";
        del.addEventListener("click", async () => {
          const res = await supabase.from("markets").delete().eq("id", m.id);
          if (res.error) setStatus("Kon niet verwijderen");
        });

        head.appendChild(left);
        head.appendChild(del);
        card.appendChild(head);

        if (!opts.length) {
          const h = document.createElement("p");
          h.className = "hint";
          h.textContent = "Voeg opties toe aan deze markt.";
          card.appendChild(h);
        } else {
          const grid = document.createElement("div");
          grid.className = "optGrid";

          for (const o of opts) {
            const st = optionStake.get(o.id) || 0;
            const { prob, odds } = impliedOdds(totalStake, st, nOptions);

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "optBtn";
            btn.addEventListener("click", async () => {
              await placeOrUpdateSelection(m.id, o.id);
            });

            const pct = (prob * 100);
            const pctTxt = Number.isFinite(pct) ? (pct.toFixed(2) + "%") : "0.00%";
            const stakeTxt = st > 0 ? money(st) : "€0,00";

            btn.innerHTML =
              "<div class='optTop'>" +
                "<div class='optLabel'>" + escapeHtml(o.label) + "</div>" +
                "<div class='optOdds mono'>" + fmtOdds(odds) + "</div>" +
              "</div>" +
              "<div class='optMeta'>" +
                "<span>Kans " + pctTxt + "</span>" +
                "<span>Inzet " + stakeTxt + "</span>" +
              "</div>";

            grid.appendChild(btn);
          }

          card.appendChild(grid);
        }

        els.marketsWrap.appendChild(card);
      }
    }

    function renderSelections() {
      els.selectionTableWrap.innerHTML = "";

      if (!session) {
        els.selectionSummary.textContent = "Join een sessie.";
        return;
      }

      if (!selections.length) {
        els.selectionSummary.textContent = "Nog geen inzetten geplaatst.";
        return;
      }

      let totalAll = 0;
      for (const s of selections) {
        const st = Number(s.stake || 0);
        if (Number.isFinite(st) && st > 0) totalAll += st;
      }

      els.selectionSummary.innerHTML =
        "<div><strong>Aantal inzetten:</strong> " + selections.length + "</div>" +
        "<div><strong>Totaal inzet over alles:</strong> " + money(totalAll) + "</div>";

      const table = document.createElement("table");
      table.className = "table";
      table.innerHTML =
        "<thead><tr>" +
          "<th>Speler</th><th>Markt</th><th>Keuze</th><th>Inzet</th><th>Live odds in markt</th><th>Live kans</th>" +
        "</tr></thead>";

      const tbody = document.createElement("tbody");

      for (const s of selections) {
        const marketId = s.market_id;
        const optionId = s.option_id;

        const stats = getMarketStakeStats(marketId);
        const stOnOpt = stats.optionStake.get(optionId) || 0;
        const { prob, odds } = impliedOdds(stats.totalStake, stOnOpt, stats.nOptions);

        const pct = prob * 100;
        const pctTxt = Number.isFinite(pct) ? pct.toFixed(2) + "%" : "0.00%";

        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + escapeHtml(s.players?.name || "") + "</td>" +
          "<td>" + escapeHtml(s.markets?.title || "") + "</td>" +
          "<td>" + escapeHtml(s.market_options?.label || "") + "</td>" +
          "<td>" + money(Number(s.stake || 0)) + "</td>" +
          "<td class='mono'>" + fmtOdds(odds) + "</td>" +
          "<td>" + pctTxt + "</td>";

        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      els.selectionTableWrap.appendChild(table);
    }

    function renderAll() {
      els.sessionCode.textContent = session ? session.code : "geen";
      renderPlayerSelect();
      renderPlayersList();
      renderMarketPick();
      renderMarkets();
      renderSelections();
    }

    async function joinFlow(code) {
      const joined = await joinSession(code);
      session = { id: joined.session_id, code: joined.code };
      localStorage.setItem(STORAGE.sessionCode, session.code);
      setUrlCode(session.code);
      setupRealtime();
      await refreshAll();
      setStatus("Joined");
    }

    async function createFlow() {
      const created = await createSession();
      session = { id: created.session_id, code: created.code };
      localStorage.setItem(STORAGE.sessionCode, session.code);
      setUrlCode(session.code);
      setupRealtime();
      await refreshAll();
      setStatus("Sessie gemaakt");
    }

    function leaveFlow() {
      teardownRealtime();
      session = null;
      players = [];
      markets = [];
      optionsByMarket = new Map();
      selections = [];
      localStorage.removeItem(STORAGE.sessionCode);
      renderAll();
      setStatus("Left");
    }

    // Events
    els.btnCreate.addEventListener("click", async () => {
      try { await createFlow(); }
      catch { setStatus("Create faalde"); }
    });

    els.btnJoin.addEventListener("click", async () => {
      try { await joinFlow(els.joinCode.value); }
      catch { setStatus("Join code ongeldig"); }
    });

    els.btnLeave.addEventListener("click", () => leaveFlow());

    els.playerSelect.addEventListener("change", () => {
      localStorage.setItem(STORAGE.playerId, els.playerSelect.value || "");
      renderPlayerSelect();
    });

    els.playerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!session) return;

      const name = String(els.playerName.value || "").trim().replace(/\s+/g, " ");
      if (!name) return;

      const user = (await supabase.auth.getUser()).data.user;

      const res = await supabase.from("players").insert({
        session_id: session.id,
        name,
        created_by: user.id
      });

      if (res.error) setStatus("Kon speler niet toevoegen");
      els.playerName.value = "";
    });

    els.marketForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!session) return;

      const title = String(els.marketTitle.value || "").trim();
      const matchLabel = String(els.marketMatch.value || "").trim();
      if (!title) return;

      const user = (await supabase.auth.getUser()).data.user;

      const res = await supabase.from("markets").insert({
        session_id: session.id,
        title,
        match_label: matchLabel,
        created_by: user.id
      });

      if (res.error) setStatus("Kon markt niet maken");
      els.marketTitle.value = "";
      els.marketMatch.value = "";
    });

    els.optionForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!session) return;

      const marketId = els.marketPick.value;
      const label = String(els.optLabel.value || "").trim();
      if (!marketId || !label) return;

      const existing = optionsByMarket.get(marketId) || [];
      const sort = existing.length;

      const res = await supabase.from("market_options").insert({
        market_id: marketId,
        label,
        odds: 1.01,
        sort
      });

      if (res.error) setStatus("Kon optie niet maken");
      els.optLabel.value = "";
    });

    // Boot
    async function boot() {
      try {
        const s = await ensureAnonAuth();
        els.userId.textContent = s.user.id;

        const savedPlayer = localStorage.getItem(STORAGE.playerId);
        if (savedPlayer) els.playerSelect.value = savedPlayer;

        const urlCode = new URLSearchParams(location.search).get("code");
        const savedCode = urlCode || localStorage.getItem(STORAGE.sessionCode);

        if (savedCode) {
          els.joinCode.value = savedCode;
          await joinFlow(savedCode);
        } else {
          renderAll();
        }
      } catch {
        setStatus("Auth probleem");
      }
    }

    boot();
  </script>
</body>
</html>